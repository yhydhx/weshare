{% extends "frontEnd/base.html" %}<!-- 继承基础模板 -->
{% load staticfiles %}<!-- 加载全局变量 -->

{% block body %}
<!-- ZUI 时间选择器 -->
<link rel="stylesheet" type="text/css" href="{% static 'frontEnd/plugins/datetimepicker/datetimepicker.min.css'%}">




  <div class="container" style="margin-top: 60px;">
  	<div class="row">
          {% include "frontEnd/center-left.html" %}<!-- 加载左侧栏 -->
  		    <div class="col-md-10">
              <div class="row" style="margin-top: 30px; margin-bottom:30px; ">
                  <div class="col-xs-1"></div>
                  <div class="col-xs-2">
                      <div class="row" style="color:red; font-size: 20px; padding-top:5px; padding-bottom:5px; ">预约</div>
                      <div class="row" style="display: flex;justify-content: center; ">
                          <div style=" width:40px; height:40px; background-color:red; border-radius:20px;">
                              <span style="height:40px; line-height:40px; display:block; color:#FFF; font-size: 25px; text-align:center">1</span>
                          </div>
                      </div>
                  </div>

                  <!-- 确认 -->
                  {% if appointment.state == 0 %}
                  <div class="col-xs-2">
                      <div class="row" style="color:gray; font-size: 20px; padding-top:5px; padding-bottom:5px; ">确认</div>
                      <div class="row" style="display: flex;justify-content: center; ">
                          <div style=" width:40px; height:40px; background-color:gray; border-radius:20px;">
                              <span style="height:40px; line-height:40px; display:block; color:#FFF; font-size: 25px; text-align:center">2</span>
                          </div>
                      </div>
                  </div>
                  {% elif appointment.state == 1 or appointment.state == 2 or appointment.state == 3 or appointment.state == 4 %}
                  <div class="col-xs-2">
                      <div class="row" style="color:red; font-size: 20px; padding-top:5px; padding-bottom:5px; ">确认</div>
                      <div class="row" style="display: flex;justify-content: center; ">
                          <div style=" width:40px; height:40px; background-color:red; border-radius:20px;">
                              <span style="height:40px; line-height:40px; display:block; color:#FFF; font-size: 25px; text-align:center">2</span>
                          </div>
                      </div>
                  </div>
                  {% endif %}

                  <!-- 付款 -->
                  {% if appointment.state == 0 or appointment.state == 1 %}
                    <div class="col-xs-2">
                      <div class="row" style="color:gray; font-size: 20px; padding-top:5px; padding-bottom:5px; ">付款</div>
                      <div class="row" style="display: flex;justify-content: center; ">
                          <div style=" width:40px; height:40px; background-color:gray; border-radius:20px;">
                              <span style="height:40px; line-height:40px; display:block; color:#FFF; font-size: 25px; text-align:center">3</span>
                          </div>
                      </div>
                    </div>
                  {% elif appointment.state == 2 or appointment.state == 3 or appointment.state == 4 %}
                    <div class="col-xs-2">
                      <div class="row" style="color:red; font-size: 20px; padding-top:5px; padding-bottom:5px; ">付款</div>
                      <div class="row" style="display: flex;justify-content: center; ">
                          <div style=" width:40px; height:40px; background-color:red; border-radius:20px;">
                              <span style="height:40px; line-height:40px; display:block; color:#FFF; font-size: 25px; text-align:center">3</span>
                          </div>
                      </div>
                  </div>
                  {% endif %}

                  <!-- 完成 -->
                  {% if appointment.state == 0 or appointment.state == 1 or appointment.state == 2 %}
                  <div class="col-xs-2">
                      <div class="row" style="color:gray; font-size: 20px; padding-top:5px; padding-bottom:5px; ">完成</div>
                      <div class="row" style="display: flex;justify-content: center; ">
                          <div style=" width:40px; height:40px; background-color:gray; border-radius:20px;">
                              <span style="height:40px; line-height:40px; display:block; color:#FFF; font-size: 25px; text-align:center">4</span>
                          </div>
                      </div>
                  </div>
                  {% elif appointment.state == 3 or appointment.state == 4 %}
                  <div class="col-xs-2">
                      <div class="row" style="color:red; font-size: 20px; padding-top:5px; padding-bottom:5px; ">完成</div>
                      <div class="row" style="display: flex;justify-content: center; ">
                          <div style=" width:40px; height:40px; background-color:red; border-radius:20px;">
                              <span style="height:40px; line-height:40px; display:block; color:#FFF; font-size: 25px; text-align:center">4</span>
                          </div>
                      </div>
                  </div>
                  {% endif %}

                  <!-- 评价 -->
                  {% if appointment.state == 0 or appointment.state == 1 or appointment.state == 2 or appointment.state == 3 %}
                  <div class="col-xs-2">
                      <div class="row" style="color:gray; font-size: 20px; padding-top:5px; padding-bottom:5px; ">评价</div>
                      <div class="row" style="display: flex;justify-content: center; ">
                          <div style=" width:40px; height:40px; background-color:gray; border-radius:20px;">
                              <span style="height:40px; line-height:40px; display:block; color:#FFF; font-size: 25px; text-align:center">5</span>
                          </div>
                      </div>
                  </div>
                  {% elif appointment.state == 4 %}
                  <div class="col-xs-2">
                      <div class="row" style="color:red; font-size: 20px; padding-top:5px; padding-bottom:5px; ">评价</div>
                      <div class="row" style="display: flex;justify-content: center; ">
                          <div style=" width:40px; height:40px; background-color:red; border-radius:20px;">
                              <span style="height:40px; line-height:40px; display:block; color:#FFF; font-size: 25px; text-align:center">5</span>
                          </div>
                      </div>
                  </div>
                  {% endif %}
                  <div class="col-xs-1"></div>
              </div>

              <table class="table table-bordered ">
                <tr>
                    <td colspan="3" style="text-align:left;">编号：{{ appointment.appointment_id }} 发起时间：{{ appointment.recommend_begin_time | date:"Y-m-d" }}</td>
                </tr>
                <tr>
                    <td>
                        <div class="row">
                            <div class="col-md-3"><img src="{{ appointment.from_user_icon }}" style="height: 80px; width: 80px; border: 1px solid #cccccc; border-radius: 50%;"></div>
                            <div class="col-md-9"><h3>{{ appointment.feature_name }}</h3><p>{{ appointment.host_name }} {{ appointment.host_motto }}</p></div>
                        </div>
                    </td>
                    <td>
                      <h4>
                        {% if appointment.state == 0 %}
                          等待分享家确定
                        {% elif appointment.state == 1 %}
                          等待付款
                        {% elif appointment.state == 2 %}
                          已付款
                        {% elif appointment.state == 3 %}
                          约见完成
                        {% elif appointment.state == 4 %}
                          已评价
                        {% endif %}
                      </h4>
                    </td>
                    
                </tr>
              </table>

              <hr style="border: none;border-top: 1px solid black; ">

              <!-- <div class="form-group">
                  <label style="font-size: 15px; ">简要介绍自己的情况，并描述要咨询的问题</label>
                  <textarea class="form-control" rows="4" placeholder="我是清华大学计算机专业大三的学生，专业排名前百分之三十，有多个关于自动驾驶的项目经历。本科毕业后想去BAT等公司从事与计算机视觉相关的工作。想知道现在开始该如何准备？比如该熟悉哪些开源项目，或是该多积累哪种平台的开发经验。"></textarea>
              </div>                                
              <div class="form-group">
                  <label style="font-size: 15px; ">告诉分享者你所希望的见面时间与约聊时长</label>
                  <textarea class="form-control" rows="4" placeholder="我每周一／三下午2点到晚上6点都有空，我想请教的细节问题比较多，觉得预约3个小时比较合适。"></textarea>
              </div> -->

              <div class="panel panel-default">
                <div class="panel-heading"><h4>简要介绍自己的情况，并描述要咨询的问题</h4></div>
                <div class="panel-body">
                  <p style="font-size:20px;">{{ appointment.intro_and_question }}</p>
                </div>
              </div>

              <div class="panel panel-default">
                <div class="panel-heading"><h4>告诉分享者你所希望的见面时间与约聊时长</h4></div>
                <div class="panel-body">
                  <p style="font-size:20px;">{{ appointment.appointment_time }}</p>
                </div>
              </div>

              <hr style="border: none;border-top: 1px solid black; ">

              


              {% if appointment.state > 0 and appointment.state < 5 %}

              <div class="panel panel-default" >
                <div class="panel-heading" style="text-align: left; "><h4>{{ appointment.host_name }} 说：</h4></div>
                <div class="panel-body">
                  <p style="font-size:20px;">{{ appointment.recommend_info }}</p>
                </div>
              </div>

              <table class="table table-bordered ">
                <tr>
                    <td>
                      日期
                    </td>
                    <td>
                      时间
                    </td>
                    <td>
                      费用
                    </td>
                </tr>
                <tr>
                    <td>
                      {{ appointment.recommend_begin_time | date:"Y-m-d" }}
                    </td>
                    <td>
                      {{ appointment.recommend_begin_time | date:"H:i" }}
                    </td>
                    <td>
                      {{ appointment.recommend_length }}小时共计{{ appointment.recommend_salary }}元
                    </td>
                </tr>
              </table>
              {% endif %}


              <!-- bootstrap 弹出框 -->
              <!-- Button trigger modal -->
              {% if appointment.state == 0 %}
                <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal2">
                  约见
                </button>
              {% elif appointment.state == 1 %}
                <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal2">
                  编辑
                </button>
                <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
                  回复
                </button>
              {% elif appointment.state == 2 %}
                <button type="button" class="btn btn-primary btn-lg" disabled="disabled">
                  买家已付款
                </button>
              {% endif %}

              

              {% if appointment.state == 0 %}
                <!-- Modal2 -->
                <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">请编辑约见信息、时间和费用</h4>
                      </div>

                      <form action="/bill/host_certify" method="post" id="yuejian">

                      {% csrf_token %}
                      <div class="modal-body">
                        <input type="hidden" name="appnt_id" value="{{ appointment.id }}">
                        <input type="hidden" name="recommend_begin_time" id="recommend_begin_time" value="">
                        <input type="hidden" name="recommend_end_time" id="recommend_end_time" value="">

                        <label for="">编辑回复</label>
                        <textarea name="recommend_info" class="form-control" rows="3"></textarea>
                        
                        <label for="">约见日期</label>
                        <input type="text" id="date" class="form-control form-date" placeholder="点击选择约见日期">

                        <label for="">开始时间</label>
                        <input type="text" id="begin" class="form-control form-time" placeholder="请输入此次约见的开始时间" onchange="InputBegin();InputTime();InputPrices(); ">

                        <label for="">结束时间</label>
                        <input type="text" id="end" class="form-control form-time" placeholder="请输入此次约见的结束时间" onchange="InputEnd();InputTime();InputPrices(); ">

                        <label for="">约见时长(h)</label>
                        <input type="text" name="recommend_length" id="time" class="form-control" readonly="readonly">
                        
                        <label for="">费用单价</label>
                        <input type="number" name="recommend_payment" id="price" class="form-control" placeholder="请输入每小时的费用" onkeyup="InputPrice();InputPrices();if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'0')}else{this.value=this.value.replace(/\D/g,'')}">
                        
                        <label for="">费用总价</label>
                        <input type="number" name="recommend_salary" id="prices" class="form-control" readonly="readonly">
                          
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button class="btn btn-primary" onclick="yuejian();return false;">确认</button>
                      </div>

                      </form>

                    </div>
                  </div>
                </div>
              {% elif appointment.state == 1 %}

                <!-- Modal -->
                <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">输入回复内容</h4>
                      </div>

                      <form action="/bill/communicate" method="post">

                      {% csrf_token %}
                      <div class="modal-body">
                          
                            <input type="hidden" name="appnt_id" value="{{ appointment.id }}">
                            <div class="form-group">
                              <textarea class="form-control" name="message" rows="3"></textarea>
                            </div>
                          
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">确认</button>
                      </div>

                      </form>

                    </div>
                  </div>
                </div>

                <!-- Modal2 -->
                <div class="modal fade" id="myModal2" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">修改约见信息、时间和费用</h4>
                      </div>

                      <form action="/bill/host_certify" method="post" id="yuejian">

                      {% csrf_token %}
                      <div class="modal-body">
                        <input type="hidden" name="appnt_id" value="{{ appointment.id }}">
                        <input type="hidden" name="recommend_begin_time" id="recommend_begin_time" value="">
                        <input type="hidden" name="recommend_end_time" id="recommend_end_time" value="">

                        <label for="">编辑回复</label>
                        <textarea name="recommend_info" class="form-control" rows="3">{{ appointment.recommend_info }}</textarea>
                        
                        <label for="">约见日期</label>
                        <input type="text" id="date" class="form-control form-date" placeholder="点击选择约见日期" value="{{ appointment.recommend_begin_time | date:'Y-m-d' }}">

                        <label for="">开始时间</label>
                        <input type="text" id="begin" class="form-control form-time" placeholder="请输入此次约见的开始时间" onchange="InputBegin();InputTime();InputPrices(); " value="{{ appointment.recommend_begin_time | date:'H:i'  }}">

                        <label for="">结束时间</label>
                        <input type="text" id="end" class="form-control form-time" placeholder="请输入此次约见的结束时间" onchange="InputEnd();InputTime();InputPrices(); " value="{{ appointment.recommend_end_time | date:'H:i'  }}">

                        <label for="">约见时长(h)</label>
                        <input type="text" name="recommend_length" id="time" class="form-control" readonly="readonly" value="{{ appointment.recommend_length }}">
                        
                        <label for="">费用单价</label>
                        <input type="number" name="recommend_payment" id="price" class="form-control" placeholder="请输入每小时的费用" onkeyup="InputPrice();InputPrices();if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'0')}else{this.value=this.value.replace(/\D/g,'')}" value="{{ appointment.recommend_payment }}">
                        
                        <label for="">费用总价</label>
                        <input type="number" name="recommend_salary" id="prices" class="form-control" readonly="readonly" value="{{ appointment.recommend_salary }}">
                          
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        <button class="btn btn-primary" onclick="yuejian();return false;">确认</button>
                      </div>

                      </form>

                    </div>
                  </div>
                </div>
              {% endif %}

              <br><br>

              {% block messages %}
              {% for messages in messages %}
                <div class="panel panel-default">
                  <div class="panel-heading" style="text-align: left;display: flex;align-items: center; "><img src="{{ messages.user_icon }}" alt="" style="height: 38px; width: 38px; border: 1px solid #cccccc; border-radius: 50%; bottom: auto;"><h4>&nbsp;{{ messages.from_user_name }} :</h4></div>
                  <div class="panel-body">
                    <p style="font-size:20px;">{{ messages.message }}</p>
                  </div>
                </div>
              {% endfor %}
              {% endblock %}

              <br><br>
          </div>
  	</div>
  </div>

{% endblock %}

{% block js %}
<!-- <script src="{% static 'frontEnd/js/shop.js' %}"></script> -->

<!-- ZUI 时间选择器 -->
<script src="{% static 'frontEnd/plugins/datetimepicker/datetimepicker.min.js'%}"></script>
<script>
// 选择时间和日期
$(".form-datetime").datetimepicker(
{
    weekStart: 1,
    todayBtn:  1,
    autoclose: 1,
    todayHighlight: 1,
    startView: 2,
    forceParse: 0,
    showMeridian: 1,
    format: "yyyy-mm-dd hh:ii"
});
// 仅选择日期
$(".form-date").datetimepicker(
{
    language:  "zh-CN",
    weekStart: 1,
    todayBtn:  1,
    autoclose: 1,
    todayHighlight: 1,
    startView: 2,
    minView: 2,
    forceParse: 0,
    format: "yyyy-mm-dd"
});

// 选择时间
$(".form-time").datetimepicker({
    language:  "zh-CN",
    weekStart: 1,
    todayBtn:  1,
    autoclose: 1,
    todayHighlight: 1,
    startView: 1,
    minView: 0,
    maxView: 1,
    forceParse: 0,
    format: 'hh:ii'
});
</script>



<!-- 约见表单处理JS -->
<script>
//读取表单
var form = document.forms['yuejian'];

//标志位：开始时间（填写为1，未填为0）
var flagBegin = 0;
//改变标志位：开始时间
function InputBegin(){
  var begin = form.elements['begin'].value;
  if (begin != '') {
    flagBegin = 1;
  }
  else{
    flagBegin = 0;
  }
}
//标志位：结束时间（填写为1，未填为0）
var flagEnd = 0;
//改变标志位：开始时间
function InputEnd(){
  var end = form.elements['end'].value;
  if (end != '') {
    flagEnd = 1;
  }
  else{
    flagEnd = 0;
  }
}

//自动填写：约见时长
var TIME = 0;
function InputTime(){
  if (flagBegin && flagEnd == 1) {
    var begin = form.elements['begin'].value;
    var end = form.elements['end'].value;
    TIME = (end.substring(0,2)*60 + end.substring(3,5)*1 ) - (begin.substring(0,2)*60 + begin.substring(3,5)*1 );
    if (TIME <= 0) {
      alert('请输入正确的开始和结束时间');
      document.getElementById("begin").value ='';
      document.getElementById("end").value ='';
      document.getElementById("time").value = 0;
      document.getElementById("prices").value = 0;
      flagBegin = 0;
      flagEnd = 0;

    }
    else{
      TIME = (TIME/60).toFixed(2);
      document.getElementById("time").value =TIME;
    }

  }
  else{
    document.getElementById("time").value = 0;
  }
}

//标志位：费用单价（填写为1，未填为0）
var flagPrice = 0;
//改变标志位：开始时间
function InputPrice(){
  var price = form.elements['price'].value;
  if (price != '') {
    flagPrice = 1;
  }
  else{
    flagPrice = 0;
  }
}

//自动填写：费用总价
function InputPrices(){
  if (flagPrice = 1) {
    p = form.elements['price'].value * TIME;
    if (p < 0) {
      document.getElementById("prices").value = 0;
    }
    else{
      document.getElementById("prices").value = p;
    }
  }
  else{
    document.getElementById("prices").value = 0;
  }
}

//提交表单
function yuejian(){
  var beginTime = form.elements['date'].value + ' ' + form.elements['begin'].value;
  var endTime = form.elements['date'].value + ' ' + form.elements['end'].value;
  document.getElementById("recommend_begin_time").value = beginTime;
  document.getElementById("recommend_end_time").value = endTime;
  document.getElementById("yuejian").submit();
}
</script>
{% if appointment.state == 1 %}
<script>
flagBegin = 1;
flagEnd = 1;
flagPrice =1;
</script>
{% endif %}



{% endblock %}
